# Supabase Setup Guide

This guide provides the necessary SQL to set up your Supabase database for the mauri-eat application. It's important to run these queries in the Supabase SQL editor in the order presented.

## 1. Create `profiles` table

This table stores user profiles and roles, linking them to the `auth.users` table.

```sql
-- Create a table for public profiles
create table profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  phone text unique,
  role text default 'customer'::text,

  constraint username_length check (char_length(username) >= 3)
);

-- Set up Row Level Security (RLS) for profiles
alter table profiles enable row level security;
create policy "Public profiles are viewable by everyone." on profiles for select using (true);
create policy "Users can insert their own profile." on profiles for insert with check (auth.uid() = id);
create policy "Users can update own profile." on profiles for update using (auth.uid() = id);
```

## 2. Create `restaurants` table

This table holds information about the restaurants.

```sql
-- Create restaurants table
create table restaurants (
  id bigint generated by default as identity primary key,
  name text not null,
  description text,
  image_url text,
  logo text,
  bg_color text,
  rating numeric,
  delivery_time text,
  category text,
  is_open boolean default true
);

-- Set up RLS for restaurants
alter table restaurants enable row level security;
create policy "Restaurants are viewable by everyone." on restaurants for select using (true);
create policy "Admin can do anything." on restaurants for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );
create policy "Owners can update their own restaurant." on restaurants for update using ( auth.uid() in (select user_id from restaurant_owners where restaurant_id = id) );
```

## 3. Create `dishes` table

This table contains the menu items for each restaurant.

```sql
-- Create dishes table
create table dishes (
  id bigint generated by default as identity primary key,
  restaurant_id bigint references restaurants not null,
  name text not null,
  description text,
  price numeric not null,
  image text, -- for emoji
  photo_url text,
  category text
);

-- Set up RLS for dishes
alter table dishes enable row level security;
create policy "Dishes are viewable by everyone." on dishes for select using (true);
create policy "Admin can do anything." on dishes for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );
```

## 4. Create `orders` and `order_items` tables

These tables store order information.

```sql
-- Create orders table
create table orders (
  id bigint generated by default as identity primary key,
  customer_id uuid references auth.users not null,
  restaurant_id bigint references restaurants not null,
  total numeric not null,
  status text,
  customer_name text,
  customer_phone text,
  address text,
  payment_method text,
  payment_proof_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Create order_items table
create table order_items (
    id bigint generated by default as identity primary key,
    order_id bigint references orders not null,
    dish_id bigint references dishes not null,
    quantity int not null,
    price numeric not null
);

-- Set up RLS for orders
alter table orders enable row level security;
create policy "Users can view their own orders." on orders for select using ( auth.uid() = customer_id );
create policy "Owners and admins can view orders for their restaurants." on orders for select using ( (select profiles.role from profiles where profiles.id = auth.uid()) in ('admin', 'owner') and restaurant_id in (select restaurant_id from restaurant_owners where user_id = auth.uid()) );
create policy "Authenticated users can create orders." on orders for insert with check ( auth.role() = 'authenticated' );
create policy "Owners and admins can update orders for their restaurants." on orders for update using ( (select profiles.role from profiles where profiles.id = auth.uid()) in ('admin', 'owner') and restaurant_id in (select restaurant_id from restaurant_owners where user_id = auth.uid()) );

-- Set up RLS for order_items
alter table order_items enable row level security;
create policy "Users can see their own order items." on order_items for select using ( auth.uid() = (select customer_id from orders where id = order_id) );
create policy "Owners and admins can see order items for their restaurants." on order_items for select using ( (select profiles.role from profiles where profiles.id = auth.uid()) in ('admin', 'owner') and (select restaurant_id from orders where id = order_id) in (select restaurant_id from restaurant_owners where user_id = auth.uid()) );
```

## 5. Create `restaurant_owners` table

This table links users (owners) to the restaurants they manage.

```sql
create table restaurant_owners (
  id bigint generated by default as identity primary key,
  restaurant_id bigint references restaurants not null,
  user_id uuid references auth.users not null,
  unique(restaurant_id, user_id)
);

-- Set up RLS for restaurant_owners
alter table restaurant_owners enable row level security;
create policy "Admin can do anything." on restaurant_owners for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );
create policy "Owners can view their own assignments." on restaurant_owners for select using ( auth.uid() = user_id );
```

## 6. Set up automatic profile creation

This trigger automatically creates a profile for new users when they sign up.

```sql
-- This trigger automatically creates a profile for new users.
create function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, full_name, avatar_url, role)
  values (new.id, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url', 'customer');
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```

## 7. Deploy Edge Function

You need to deploy the `create-customer-and-order` edge function to your Supabase project. This function handles creating a new customer and an order in a single transaction.

First, ensure you have the [Supabase CLI](https://supabase.com/docs/guides/cli) installed. Then, from your project's root directory, run:

```bash
supabase functions deploy create-customer-and-order --no-verify-jwt
```

**Important:** If you are seeing an error like `column restaurants.is_open does not exist`, it's because your `restaurants` table is missing this column. Make sure you have run all the SQL queries in this guide.
