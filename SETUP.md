# Supabase Setup Guide

This guide provides the necessary SQL to set up your Supabase database for the mauri-eat application.

## 1. Create `profiles` table

Create a table to store user profiles and roles. This table will have a one-to-one relationship with the `auth.users` table.

```sql
-- Create a table for public profiles
create table profiles (
  id uuid references auth.users not null primary key,
  updated_at timestamp with time zone,
  username text unique,
  full_name text,
  avatar_url text,
  website text,
  role text default 'customer'::text,

  constraint username_length check (char_length(username) >= 3)
);

-- Set up Row Level Security (RLS)
-- See https://supabase.com/docs/guides/auth/row-level-security for more details.
alter table profiles
  enable row level security;

create policy "Public profiles are viewable by everyone." on profiles
  for select using (true);

create policy "Users can insert their own profile." on profiles
  for insert with check (auth.uid() = id);

create policy "Users can update own profile." on profiles
  for update using (auth.uid() = id);

-- This trigger automatically creates a profile for new users.
-- See https://supabase.com/docs/guides/auth/managing-user-data#using-triggers for more details.
create function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, full_name, avatar_url, role)
  values (new.id, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url', 'customer');
  return new;
end;
$$ language plpgsql security definer;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```

## 2. Set up `restaurants` table

```sql
-- Create restaurants table
create table restaurants (
  id bigint generated by default as identity primary key,
  name text not null,
  description text,
  image_url text,
  logo text,
  bg_color text,
  rating numeric,
  delivery_time text,
  category text,
  is_open boolean default true
);

-- Enable RLS
alter table restaurants enable row level security;

-- Allow public read access
create policy "Restaurants are viewable by everyone." on restaurants
  for select using (true);

-- Allow admin to insert/update/delete
create policy "Admin can do anything." on restaurants
  for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );

-- Allow owner to update their own restaurant
create policy "Owners can update their own restaurant." on restaurants
  for update using ( auth.uid() in (select user_id from restaurant_owners where restaurant_id = id) );

```

## 3. Set up `dishes` table

```sql
-- Create dishes table
create table dishes (
  id bigint generated by default as identity primary key,
  restaurant_id bigint references restaurants not null,
  name text not null,
  description text,
  price numeric not null,
  image text, -- for emoji
  photo_url text,
  category text
);

-- Enable RLS
alter table dishes enable row level security;

-- Allow public read access
create policy "Dishes are viewable by everyone." on dishes
  for select using (true);

-- Allow admin to insert/update/delete
create policy "Admin can do anything." on dishes
  for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );
```

## 4. Set up `orders` table

```sql
-- Create orders table
create table orders (
  id bigint generated by default as identity primary key,
  customer_id uuid references auth.users not null,
  restaurant_id bigint references restaurants not null,
  total numeric not null,
  status text,
  customer_name text,
  customer_phone text,
  address text,
  payment_method text,
  payment_proof_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table orders enable row level security;

-- Allow users to view their own orders
create policy "Users can view their own orders." on orders
  for select using ( auth.uid() = customer_id );

-- Allow owners and admins to view all orders for their restaurants
create policy "Owners and admins can view orders for their restaurants." on orders
  for select using ( (select profiles.role from profiles where profiles.id = auth.uid()) in ('admin', 'owner') and restaurant_id in (select restaurant_id from restaurant_owners where user_id = auth.uid()) );

-- Allow authenticated users to create orders
create policy "Authenticated users can create orders." on orders
  for insert with check ( auth.role() = 'authenticated' );

-- Allow owners and admins to update order status
create policy "Owners and admins can update orders for their restaurants." on orders
  for update using ( (select profiles.role from profiles where profiles.id = auth.uid()) in ('admin', 'owner') and restaurant_id in (select restaurant_id from restaurant_owners where user_id = auth.uid()) );

```

## 5. Create `restaurant_owners` table

This table links users to the restaurants they own.

```sql
create table restaurant_owners (
  id bigint generated by default as identity primary key,
  restaurant_id bigint references restaurants not null,
  user_id uuid references auth.users not null,
  unique(restaurant_id, user_id)
);
```

I will need to update the RLS policies to use this new table. I have updated the policies for `restaurants` and `orders` above. I'll also need a policy for `restaurant_owners`.

```sql
-- Enable RLS on restaurant_owners
alter table restaurant_owners enable row level security;

-- Allow admin to do anything
create policy "Admin can do anything." on restaurant_owners
    for all using ( (select profiles.role from profiles where profiles.id = auth.uid()) = 'admin' );
```
